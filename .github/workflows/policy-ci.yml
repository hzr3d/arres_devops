name: policy-ci

on:
  workflow_call:
    inputs:
      project_type:
        description: "python_service | python_lib | react_app"
        required: true
        type: string
      python_version:
        required: false
        type: string
        default: "3.11"
      node_version:
        required: false
        type: string
        default: "20"
      docker_image_name:
        description: "Image name without registry (e.g., mock_api)"
        required: false
        type: string
        default: ""
      run_integration:
        required: false
        type: boolean
        default: true
      artifact_name:
        required: false
        type: string
        default: "artifact"
      with_mock_lib:
        required: false
        type: boolean
        default: false

    secrets:
      AZURE_CLIENT_ID:
        required: false
      AZURE_TENANT_ID:
        required: false
      AZURE_SUBSCRIPTION_ID:
        required: false
      ACR_NAME:
        required: false
      ACR_LOGIN_SERVER:
        required: false
      AZURE_CONTAINERAPP_NAME:
        required: false
      AZURE_RESOURCE_GROUP:
        required: false

permissions:
  contents: read

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Checkout mock_lib (if needed)
        if: inputs.with_mock_lib
        uses: actions/checkout@v4
        with:
          repository: hzr3d/mock_lib
          path: mock_lib

      - name: Move mock_lib to parent
        if: inputs.with_mock_lib
        run: mv mock_lib ../mock_lib

      - name: Python lint (ruff)
        if: inputs.project_type != 'react_app'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      - name: Install ruff
        if: inputs.project_type != 'react_app'
        run: python -m pip install --upgrade pip ruff
      - name: Run ruff
        if: inputs.project_type != 'react_app'
        run: ruff check .

      - name: Node lint
        if: inputs.project_type == 'react_app'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: npm
      - name: Install deps
        if: inputs.project_type == 'react_app'
        run: npm ci
      - name: Run eslint (if configured)
        if: inputs.project_type == 'react_app'
        run: |
          if [ -f "package.json" ] && (cat package.json | grep -q '"lint"'); then
            npm run lint
          else
            echo "No lint script found; skipping."
          fi

  unit-tests:
    name: unit-tests
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4

      - name: Checkout mock_lib (if needed)
        if: inputs.with_mock_lib
        uses: actions/checkout@v4
        with:
          repository: hzr3d/mock_lib
          path: mock_lib

      - name: Move mock_lib to parent
        if: inputs.with_mock_lib
        run: mv mock_lib ../mock_lib

      - name: Python unit tests
        if: inputs.project_type != 'react_app'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      - name: Install deps (Python)
        if: inputs.project_type != 'react_app'
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "pyproject.toml" ]; then pip install -e .; fi
          pip install pytest
      - name: Run pytest (if tests exist)
        if: inputs.project_type != 'react_app'
        run: |
          if compgen -G "tests/test_*.py" > /dev/null; then
            pytest -q
          else
            echo "No pytest unit tests found; skipping."
          fi

      - name: Node unit tests
        if: inputs.project_type == 'react_app'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: npm
      - name: Install deps (Node)
        if: inputs.project_type == 'react_app'
        run: npm ci
      - name: Run tests (if configured)
        if: inputs.project_type == 'react_app'
        run: |
          if (cat package.json | grep -q '"test"'); then
            CI=true npm test -- --watchAll=false
          else
            echo "No test script found; skipping."
          fi

  integration-tests:
    name: integration-tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: ${{ inputs.run_integration }}
    steps:
      - uses: actions/checkout@v4

      - name: Checkout mock_lib (if needed)
        if: inputs.with_mock_lib
        uses: actions/checkout@v4
        with:
          repository: hzr3d/mock_lib
          path: mock_lib

      - name: Move mock_lib to parent
        if: inputs.with_mock_lib
        run: mv mock_lib ../mock_lib

      - name: Run integration script (if present)
        run: |
          if [ -x "scripts/integration_test.sh" ]; then
            ./scripts/integration_test.sh
          elif [ -f "scripts/integration_test.sh" ]; then
            chmod +x scripts/integration_test.sh
            ./scripts/integration_test.sh
          else
            echo "No integration test script found; skipping."
          fi

  build-artifacts:
    name: build-artifacts
    runs-on: ubuntu-latest
    needs: [integration-tests]
    permissions:
      contents: read
      id-token: write   # enables Azure OIDC if secrets are set
    env:
      ACR_NAME: ${{ secrets.ACR_NAME }}
      ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_CONTAINERAPP_NAME: ${{ secrets.AZURE_CONTAINERAPP_NAME }}
      AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
    steps:
      - uses: actions/checkout@v4

      - name: Checkout mock_lib (if needed)
        if: inputs.with_mock_lib
        uses: actions/checkout@v4
        with:
          repository: hzr3d/mock_lib
          path: mock_lib_temp

      - name: Compute image/tag
        id: meta
        run: |
          echo "sha_tag=sha-${GITHUB_SHA}" >> $GITHUB_OUTPUT
          if [ -n "${{ inputs.docker_image_name }}" ]; then
            echo "image_name=${{ inputs.docker_image_name }}" >> $GITHUB_OUTPUT
          else
            echo "image_name=${GITHUB_REPOSITORY##*/}" >> $GITHUB_OUTPUT
          fi

      - name: Build Python wheel (python_lib)
        if: inputs.project_type == 'python_lib'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Package wheel
        if: inputs.project_type == 'python_lib'
        run: |
          python -m pip install --upgrade pip build
          python -m build
          ls -la dist

      - name: Build Docker image (python_service / react_app)
        if: inputs.project_type != 'python_lib'
        run: |
          DOCKERFILE="Dockerfile"
          if [ "${{ inputs.with_mock_lib }}" == "true" ]; then
            description="Modified for CI"
            cp Dockerfile Dockerfile.ci
            sed -i 's|COPY ../mock_lib /mock_lib|COPY mock_lib_temp /mock_lib|' Dockerfile.ci
            DOCKERFILE="Dockerfile.ci"
          fi
          docker build -f "$DOCKERFILE" -t local/${{ steps.meta.outputs.image_name }}:${{ steps.meta.outputs.sha_tag }} .

      # Upload artifacts for tutorial purposes even if Azure push isn't configured
      - name: Save docker image tar
        if: inputs.project_type != 'python_lib'
        run: |
          mkdir -p out
          docker save local/${{ steps.meta.outputs.image_name }}:${{ steps.meta.outputs.sha_tag }} -o out/image.tar
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-${{ github.sha }}
          path: |
            out/**
            dist/**

      # OPTIONAL: push to ACR if secrets exist
      - name: Azure login (OIDC) - optional
        if: ${{ env.ACR_NAME != '' && env.AZURE_CLIENT_ID != '' }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Push to ACR - optional
        if: ${{ env.ACR_NAME != '' && inputs.project_type != 'python_lib' && env.AZURE_CLIENT_ID != '' }}
        env:
          ACR_NAME: ${{ env.ACR_NAME }}
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
        run: |
          az acr login --name "$ACR_NAME"
          SRC="local/${{ steps.meta.outputs.image_name }}:${{ steps.meta.outputs.sha_tag }}"
          DST="$ACR_LOGIN_SERVER/${{ steps.meta.outputs.image_name }}:${{ steps.meta.outputs.sha_tag }}"
          docker tag "$SRC" "$DST"
          docker push "$DST"

      # OPTIONAL: deploy to Azure Container Apps if configured
      - name: Deploy to Azure Container Apps - optional
        if: ${{ env.AZURE_CONTAINERAPP_NAME != '' && env.AZURE_RESOURCE_GROUP != '' && inputs.project_type != 'python_lib' && env.ACR_LOGIN_SERVER != '' && env.AZURE_CLIENT_ID != '' }}
        env:
          RG: ${{ env.AZURE_RESOURCE_GROUP }}
          APP: ${{ env.AZURE_CONTAINERAPP_NAME }}
          ACR_LOGIN_SERVER: ${{ env.ACR_LOGIN_SERVER }}
        run: |
          IMAGE="$ACR_LOGIN_SERVER/${{ steps.meta.outputs.image_name }}:${{ steps.meta.outputs.sha_tag }}"
          az containerapp update --name "$APP" --resource-group "$RG" --image "$IMAGE"
